#!/system/bin/sh
# 添加文件锁防止重复运行
(
flock -n 9 || exit 1

murongruyan() {
  path="$1"
  value="$2"
  retries=3
  delay=1

  [ ! -f "$path" ] && return 1
  chmod +w "$path" 2>/dev/null
  
  i=1
  while [ "$i" -le "$retries" ]; do
    echo "$value" > "$path" 2>/dev/null && return 0
    sleep $delay
    i=$((i + 1))
  done
  return 1
}

# 内核基础设置
murongruyan "/proc/sys/kernel/printk" "0 0 0 0"
murongruyan "/proc/sys/kernel/panic" "0"
murongruyan "/proc/sys/kernel/panic_on_oops" "0"
murongruyan "/proc/sys/kernel/hung_task_panic" "0"
murongruyan "/proc/sys/kernel/sysrq" "0"

# 虚拟内存优化
murongruyan "/proc/sys/vm/swappiness" "60"
murongruyan "/proc/sys/vm/vfs_cache_pressure" "100"
murongruyan "/proc/sys/vm/dirty_ratio" "15"
murongruyan "/proc/sys/vm/dirty_background_ratio" "5"
murongruyan "/proc/sys/vm/dirty_expire_centisecs" "1000"
murongruyan "/proc/sys/vm/dirty_writeback_centisecs" "3000"
murongruyan "/proc/sys/vm/page-cluster" "0"
murongruyan "/proc/sys/vm/stat_interval" "30"

# 调度器优化
ANDROID_VERSION=$(getprop ro.build.version.release | awk -F. '{print $1}')
[ -z "$ANDROID_VERSION" ] && ANDROID_VERSION=0

[ "$ANDROID_VERSION" -lt 15 ] && {
  murongruyan "/proc/sys/kernel/sched_boost" "0"
  murongruyan "/proc/sys/kernel/sched_boost_top_app" "0"
  murongruyan "/proc/sys/kernel/sched_cpu_high_irqload" "70"
  murongruyan "/proc/sys/kernel/sched_cstate_aware" "1"
  murongruyan "/proc/sys/kernel/sched_downmigrate" "35 35"
  murongruyan "/proc/sys/kernel/sched_upmigrate" "45 45"
  murongruyan "/proc/sys/kernel/sched_group_upmigrate" "30"
  murongruyan "/proc/sys/kernel/sched_group_downmigrate" "20"
  murongruyan "/proc/sys/kernel/sched_tunable_scaling" "0"
  murongruyan "/proc/sys/kernel/sched_stas_to_big" "0"
  murongruyan "/proc/sys/kernel/sched_shares_ratelimit" "256"
  murongruyan "/proc/sys/kernel/sched_many_wakeup_threshold" "10"
  murongruyan "/proc/sys/kernel/sched_min_task_util_for_boost" "15"
  murongruyan "/proc/sys/kernel/sched_min_task_util_for_colocation" "15"
}

# 通用调度设置
murongruyan "/proc/sys/kernel/sched_energy_aware" "1"
murongruyan "/proc/sys/kernel/sched_autogroup_enabled" "0"
murongruyan "/proc/sys/kernel/sched_latency_ns" "5000000"
murongruyan "/proc/sys/kernel/sched_min_granularity_ns" "2000000"
murongruyan "/proc/sys/kernel/sched_wakeup_granularity_ns" "3000000"
murongruyan "/proc/sys/kernel/sched_migration_cost_ns" "500000"
murongruyan "/proc/sys/kernel/sched_schedstats" "0"
murongruyan "/proc/sys/kernel/sched_rt_period_us" "1000000"
murongruyan "/proc/sys/kernel/sched_rt_runtime_us" "850000"
murongruyan "/proc/sys/kernel/sched_rr_timeslice_ms" "1"
murongruyan "/proc/sys/kernel/sched_deadline_period_max_us" "1000000"
murongruyan "/proc/sys/kernel/sched_deadline_period_min_us" "15000"
murongruyan "/proc/sys/kernel/sched_child_runs_first" "0"

# 高内核版本优化
[ $(uname -r | cut -d. -f1) -ge 4 ] && [ $(uname -r | cut -d. -f2) -ge 19 ] && {
  murongruyan "/proc/sys/kernel/sched_pelt_multiplier" "125000000"
  murongruyan "/proc/sys/kernel/sched_util_clamp_min" "128"
  murongruyan "/proc/sys/kernel/sched_util_clamp_max" "768"
  murongruyan "/proc/sys/kernel/sched_util_clamp_min_rt_default" "128"
}

# GPU优化
[ -d "/sys/class/kgsl/kgsl-3d0" ] && {
  murongruyan "/sys/class/kgsl/kgsl-3d0/thermal_pwrlevel" "0"
  murongruyan "/sys/class/kgsl/kgsl-3d0/throttling" "1"
  [ -f "/sys/class/kgsl/kgsl-3d0/force_clk_on" ] && 
    murongruyan "/sys/class/kgsl/kgsl-3d0/force_clk_on" "0"
  [ -f "/sys/class/kgsl/kgsl-3d0/force_rail_on" ] && 
    murongruyan "/sys/class/kgsl/kgsl-3d0/force_rail_on" "0"
  [ -f "/sys/class/kgsl/kgsl-3d0/force_no_nap" ] && 
    murongruyan "/sys/class/kgsl/kgsl-3d0/force_no_nap" "0"
  murongruyan "/sys/class/kgsl/kgsl-3d0/bus_split" "1"
}

[ -d "/sys/class/misc/mali0" ] && {
  murongruyan "/sys/class/misc/mali0/device/dvfs_enable" "1"
  murongruyan "/sys/class/misc/mali0/device/thermal_control" "1"
  murongruyan "/sys/class/misc/mali0/device/performance_mode" "0"
}

# I/O优化
for queue in /sys/block/*/queue; do
  devname="$(basename "$(dirname "$queue")")"
  case "$devname" in
    zram*|loop*|ram*) continue ;;
  esac

  # 设备特定设置
  read_ahead=64
  nr_req=64
  [ -d "${queue%/queue}/device" ] && {
    if grep -qi "ufs" "${queue%/queue}/device/uevent" 2>/dev/null; then
      read_ahead=128
      nr_req=128
    elif grep -qi "mmc" "${queue%/queue}/device/uevent" 2>/dev/null; then
      read_ahead=64
      nr_req=64
    fi
  }

  # 调度器
  [ -f "$queue/scheduler" ] && {
    for sched in mq-deadline kyber bfq none; do
      grep -qw "$sched" "$queue/scheduler" && {
        echo "$sched" > "$queue/scheduler" 2>/dev/null
        break
      }
    done
  }

  # 预读值
  [ -f "$queue/read_ahead_kb" ] && echo "$read_ahead" > "$queue/read_ahead_kb" 2>/dev/null

  # 请求队列
  [ -f "$queue/nr_requests" ] && echo "$nr_req" > "$queue/nr_requests" 2>/dev/null

  # 请求亲和性
  [ -f "$queue/rq_affinity" ] && echo "1" > "$queue/rq_affinity" 2>/dev/null
done

# RAM/ZRAM优化
for ram in /sys/block/ram*/queue; do
  murongruyan "$ram/read_ahead_kb" "32"
done
[ -d "/sys/block/zram0" ] && murongruyan "/sys/block/zram0/queue/read_ahead_kb" "32"

# RNG优化
murongruyan "/proc/sys/kernel/random/write_wakeup_threshold" "2048"
murongruyan "/proc/sys/kernel/random/read_wakeup_threshold" "512"
murongruyan "/proc/sys/kernel/random/urandom_min_reseed_secs" "256"

# Dalvik优化
TOTAL_RAM_MB=$(awk '/MemTotal/ {print int($2/1024)}' /proc/meminfo)
set_dalvik_prop() {
  setprop "$1" "$2" 2>/dev/null
}

if [ "$TOTAL_RAM_MB" -le 3072 ]; then
  set_dalvik_prop dalvik.vm.heapstartsize "8m"
  set_dalvik_prop dalvik.vm.heapgrowthlimit "96m"
  set_dalvik_prop dalvik.vm.heapsize "256m"
  set_dalvik_prop dalvik.vm.heapminfree "4m"
  set_dalvik_prop dalvik.vm.heapmaxfree "8m"
elif [ "$TOTAL_RAM_MB" -le 4096 ]; then
  set_dalvik_prop dalvik.vm.heapstartsize "12m"
  set_dalvik_prop dalvik.vm.heapgrowthlimit "128m"
  set_dalvik_prop dalvik.vm.heapsize "384m"
  set_dalvik_prop dalvik.vm.heapminfree "6m"
  set_dalvik_prop dalvik.vm.heapmaxfree "12m"
elif [ "$TOTAL_RAM_MB" -le 6144 ]; then
  set_dalvik_prop dalvik.vm.heapstartsize "16m"
  set_dalvik_prop dalvik.vm.heapgrowthlimit "192m"
  set_dalvik_prop dalvik.vm.heapsize "512m"
  set_dalvik_prop dalvik.vm.heapminfree "8m"
  set_dalvik_prop dalvik.vm.heapmaxfree "16m"
elif [ "$TOTAL_RAM_MB" -le 8192 ]; then
  set_dalvik_prop dalvik.vm.heapstartsize "24m"
  set_dalvik_prop dalvik.vm.heapgrowthlimit "256m"
  set_dalvik_prop dalvik.vm.heapsize "768m"
  set_dalvik_prop dalvik.vm.heapminfree "8m"
  set_dalvik_prop dalvik.vm.heapmaxfree "16m"
else
  set_dalvik_prop dalvik.vm.heapstartsize "32m"
  set_dalvik_prop dalvik.vm.heapgrowthlimit "384m"
  set_dalvik_prop dalvik.vm.heapsize "1024m"
  set_dalvik_prop dalvik.vm.heapminfree "12m"
  set_dalvik_prop dalvik.vm.heapmaxfree "24m"
fi

murongruyan "/proc/sys/vm/drop_caches" "3"

) 9>/data/adb/modules/muronggameopt/tmp/kernel.lock

exit 0